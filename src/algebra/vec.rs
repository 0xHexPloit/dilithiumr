use crate::algebra::poly::Polynomial;
use std::ops::{AddAssign, Index, IndexMut, Mul, Sub};
use std::slice::IterMut;

#[derive(Debug, Copy, Clone, PartialEq)]
pub struct PolyVec<const N: usize> {
    pub(crate) data: [Polynomial; N],
}

impl<const N: usize> PolyVec<N> {
    pub fn iter_mut(&mut self) -> IterMut<Polynomial> {
        self.data.iter_mut()
    }

    pub fn to_ntt(&self) -> Self {
        let mut clone = self.clone();
        for i in 0..N {
            clone[i].ntt();
        }
        clone
    }

    pub fn caddq(&mut self) {
        for i in 0..N {
            self[i].caddq();
        }
    }

    pub fn reduce(&mut self) {
        for i in 0..N {
            self[i].reduce()
        }
    }

    /// This function returns a Boolean indicating whether the infinite norm of the vector of
    /// polynomials is greater than or equal to a specific bound.
    ///
    /// # Arguments:
    /// * `bound` - The upper bound
    pub fn check_infinite_norm(&self, bound: usize) -> bool {
        for poly in &self.data {
            if poly.check_infinite_norm(bound) {
                return true;
            }
        }

        false
    }

    pub fn power2round(&self) -> (PolyVec<N>, PolyVec<N>) {
        let mut poly_vec_zero = PolyVec::<N>::default();
        let mut poly_vec_one = PolyVec::<N>::default();

        for i in 0..N {
            let (poly_zero, poly_one) = self[i].power2round();
            poly_vec_zero[i] = poly_zero;
            poly_vec_one[i] = poly_one;
        }

        (poly_vec_zero, poly_vec_one)
    }

    pub fn expand_mask<const ARR_SIZE: usize, const GAMMA_ONE: usize>(
        rho_prime: &[u8],
        kappa: u16,
    ) -> PolyVec<N> {
        let mut vec = PolyVec::default();
        let mut nonce = kappa;

        for i in 0..N {
            Polynomial::fill_uniform_gamma::<ARR_SIZE, GAMMA_ONE>(rho_prime, nonce, &mut vec[i]);
            nonce += 1;
        }

        vec
    }

    pub fn decompose<const GAMMA_TWO: usize>(vec: &PolyVec<N>) -> (PolyVec<N>, PolyVec<N>) {
        let mut r_zero = PolyVec::<N>::default();
        let mut r_one = PolyVec::<N>::default();

        for i in 0..N {
            Polynomial::decompose::<GAMMA_TWO>(&mut r_zero[i], &mut r_one[i], &vec[i]);
        }

        return (r_one, r_zero);
    }

    pub fn make_hint<const GAMMA_TWO: usize>(
        output_vec: &mut PolyVec<N>,
        v_one: &PolyVec<N>,
        v_zero: &PolyVec<N>,
    ) -> usize {
        let mut number_ones = 0;

        for i in 0..N {
            number_ones +=
                Polynomial::make_hint::<GAMMA_TWO>(&mut output_vec[i], &v_one[i], &v_zero[i]);
        }

        number_ones
    }

    pub fn expand_s<const ETA: usize>(rho_prime: &[u8], nonce_init_value: u16) -> PolyVec<N> {
        let mut vec = PolyVec::<N>::default();
        let mut nonce = nonce_init_value;
        vec.iter_mut().for_each(|poly| {
            Polynomial::fill_uniform_eta::<ETA>(rho_prime, nonce, poly);
            nonce += 1
        });
        vec
    }
}

impl<const N: usize> Default for PolyVec<N> {
    fn default() -> Self {
        let data = [Polynomial::default(); N];
        Self { data }
    }
}

impl<const N: usize> Index<usize> for PolyVec<N> {
    type Output = Polynomial;
    fn index(&self, index: usize) -> &Self::Output {
        &self.data[index]
    }
}

impl<const N: usize> IndexMut<usize> for PolyVec<N> {
    fn index_mut(&mut self, index: usize) -> &mut Self::Output {
        &mut self.data[index]
    }
}

impl<const N: usize> AddAssign<&PolyVec<N>> for PolyVec<N> {
    fn add_assign(&mut self, rhs: &PolyVec<N>) {
        for i in 0..N {
            self[i] += &rhs[i]
        }
    }
}

impl<const N: usize> Mul<&PolyVec<N>> for PolyVec<N> {
    type Output = Polynomial;
    fn mul(self, rhs: &PolyVec<N>) -> Self::Output {
        let mut poly = Polynomial::default();

        for i in 0..N {
            poly += &(self[i] * &rhs[i]);
        }

        poly.reduce();
        poly.ntt_to_montgomery();
        poly
    }
}

impl<const N: usize> Mul<&Polynomial> for PolyVec<N> {
    type Output = PolyVec<N>;

    fn mul(self, rhs: &Polynomial) -> Self::Output {
        let mut vec = PolyVec::<N>::default();

        for i in 0..N {
            vec[i] = self[i] * rhs;
            vec[i].ntt_to_montgomery();
            vec[i].reduce();
        }

        vec
    }
}

impl<const N: usize> Sub<&PolyVec<N>> for PolyVec<N> {
    type Output = PolyVec<N>;
    fn sub(self, rhs: &PolyVec<N>) -> Self::Output {
        let mut vec = PolyVec::default();

        for i in 0..N {
            vec[i] = self[i] - &rhs[i]
        }

        vec
    }
}

#[cfg(test)]
mod tests {
    use crate::algebra::poly::Polynomial;
    use crate::algebra::vec::PolyVec;
    use crate::constants::{H_TEST, Q, W_ONE_TEST};

    #[test]
    fn test_should_produce_the_correct_h_vec() {
        let mut h = PolyVec::<4>::default();

        let v_zero = PolyVec::<4> {
            data: [
                Polynomial {
                    coefficients: [
                        11409, 49595, 53910, -101307, -3231, 44517, 60445, 67493, 15125, -32813,
                        -18083, 10085, -15758, 26181, 14869, -17903, 31327, -82278, 74485, 54238,
                        -82986, -72018, -41757, -47174, 2289, 49820, 54100, -77382, 69032, -27249,
                        49109, -115131, 63375, 30998, -53919, -80285, -33352, -26143, -107436,
                        -96922, 62580, 55747, 60965, -37373, -44729, -79650, 56077, 56377, 8579,
                        -34661, -66190, 84105, -53230, -80136, -78673, 27750, 29673, -14168,
                        -99137, 97602, -31268, 34218, -38589, 93363, 88, 6478, -32883, 72239,
                        -25486, -69299, 8699, -92957, 45703, -20166, 33908, -71917, -26101, -67746,
                        136357, 122470, -20000, -82221, -97631, -35996, 23583, 82193, -58409,
                        -10707, -37369, 31480, -25444, 78308, -83258, 86331, -82314, -42181, 39853,
                        78944, 68190, 85799, 44307, 30540, -68488, 76709, 42338, 85243, 8349,
                        53029, -34078, 52533, 3975, 15374, -94488, -43548, 53790, -15188, 55142,
                        8122, -20953, -94099, -17200, 70098, -10255, -19794, 52414, -41519, 6900,
                        -73976, -71788, -25735, 121184, 91419, 39418, 98476, 93705, -36432, 46238,
                        -70499, 3840, -56736, -15646, 29671, -553, -32183, -71375, -16804, -89502,
                        86402, 102256, -64066, -59894, -9846, -17829, 80425, 121089, -57774,
                        -61141, -51521, -91089, 28176, -59410, 51338, 83398, 16243, -80847, -84930,
                        27647, 67310, -76744, 1787, 33541, 41798, 5989, 14637, 39609, 60581, -1128,
                        52118, 93694, -101674, -34687, -75422, 19161, 86551, 1589, 48275, 30619,
                        -115980, -23824, 73867, -23926, -62970, 64379, 77810, 44308, -71302, 21791,
                        -23272, -41701, 8443, 84747, 95342, -112449, 50699, 40590, 105680, 55531,
                        -55257, 47680, 52256, -48837, -49582, -72538, 99977, -68480, 31425, 31608,
                        35660, -20558, 33539, -58544, -35727, 115272, -11374, 68970, -89457,
                        -103097, 91709, -27985, -27176, 35685, 54662, -70821, 57672, -50332,
                        -46286, 8021, 28258, 53631, 5907, -40157, -1279, 72754, 3793, -6833,
                        -30933, -75381, 47816, 47323, 99110, 86714, 79993, -53895, -25388, -65725,
                        30526,
                    ],
                },
                Polynomial {
                    coefficients: [
                        -25177, -70762, 80852, -35603, 74192, 25144, -104986, -5259, -20274, 3828,
                        63108, 65478, 68040, 36578, -50068, -46585, -74435, 51532, -28847, -15169,
                        37912, 8383, -35605, 88195, 42635, -27756, 11510, -52002, 50186, -71830,
                        -98268, 77048, -54501, -88976, -66551, -10832, -49361, 72996, 5640, -50336,
                        42112, -63330, 6400, 51633, -58013, -50738, 3714, 32661, -25965, -44193,
                        -28108, -23076, 99985, 82750, 60566, -1010, -70432, 7079, 54232, 57501,
                        -21573, 61053, 41579, 41881, -41766, -58493, -61660, 45088, -49612, -85159,
                        32219, -58210, 64554, -21987, -68650, -108713, -28669, 8907, -30377,
                        -38389, 96579, -65190, -19525, -52369, 61543, -46836, -9945, 95149, 12469,
                        93510, 6265, -74588, -77837, 48463, -2917, -4709, -68288, 9997, 83381,
                        -8874, 54369, -91624, 59791, 75956, -36004, -85518, -81774, -25085, -82479,
                        627, 13512, 93766, -91047, -89205, -11687, -20512, 78266, 20284, 82219,
                        -73279, -23029, -9882, 22912, 63241, -12580, -68206, -42766, -53070,
                        -39426, -40532, 38034, -60265, 99365, 54833, -14598, -25643, 72871,
                        -101038, -99569, -64107, 50701, 60463, -71544, -60133, 79265, -61960,
                        29587, -57758, -64038, -62032, 8901, 48859, -73320, -77113, 98593, 25759,
                        -66823, 92765, 106533, 18881, -28043, 48725, -67923, -68906, 23082, 18039,
                        -86543, -17522, -6679, 27887, -40064, -100565, -9087, -93776, -72321,
                        -60299, 62351, 50742, -12274, -48116, 16612, -26520, -11675, -78380, 3451,
                        76060, 23262, 89543, -59010, 26873, -80048, 9954, -56907, 14989, -68281,
                        98177, -72879, -83608, 31122, 13161, 78347, 875, 29083, -990, -55188,
                        65373, 49126, -85752, 3326, -57878, 9270, -67085, 15275, -43094, -44394,
                        48017, 14044, 8131, -50042, 8054, 2609, 37734, 63047, -27552, 25788,
                        -120922, -4396, -1824, -79087, 74996, -7079, 69229, -44565, 80360, 41991,
                        83731, -61340, -26233, -96476, -104459, 3723, -5107, 72935, 61592, -84365,
                        -44926, 55862, -41600, -94216, -18525, -20592, 4112, 71525, 47023, 55506,
                        58213,
                    ],
                },
                Polynomial {
                    coefficients: [
                        27312, 70839, -67732, -88527, 37891, 21911, -8149, 20214, -35651, 72309,
                        -33326, 89975, -48556, -44393, -21733, -11307, 80914, 79417, -23585, 56406,
                        -9984, 62802, 48546, -7559, -50146, -46898, 24545, -82490, -3353, -10662,
                        97186, -46974, -37785, 19392, 34606, 53543, 92275, 24721, 160, -75292,
                        37763, -55347, 10716, 192, 83701, -81854, 37707, -50421, -55651, 58068,
                        -58598, 16240, -41180, 9782, 6873, 27450, 51181, 97865, -84569, -3230,
                        58668, 31874, -10967, 57277, -750, 25242, -99991, -54269, 40529, 16793,
                        37242, 88193, -48338, -7428, -39634, -67563, 7734, 62828, 84340, 93846,
                        -24055, -52178, 64206, -29015, 9332, 45225, 73654, -9476, 24142, 74150,
                        -68578, 55039, -66828, -78827, 857, 52450, 41414, 43001, 20753, 16581,
                        -30620, -69299, -109806, 69928, 18820, -27265, -23342, 38813, 43913,
                        -49777, -93022, 47502, 48465, -51922, -28932, 30307, 79719, -22541, -50096,
                        -68665, -23584, 8314, -70694, -54534, -43264, -26414, 56146, 8215, -93190,
                        79232, 11633, -70414, 53269, -33145, 11804, -67414, 8980, 5646, -53299,
                        -28963, -95639, -69898, -27868, -35754, 20217, -59060, -18520, -7840,
                        -49422, -38951, -91037, -46770, -49364, -14876, -23483, 80654, -25842,
                        -91713, 12498, -43660, 7768, -9868, -8421, -36014, 88920, -45240, -3577,
                        53700, 62088, 112336, -32460, 36786, -14364, 101396, -61723, 30392, 62619,
                        -21042, -92523, -11263, -50010, 35703, -2296, -76739, -67201, -20563,
                        -64124, 49806, -36608, 37101, -26701, -65909, -87552, 96830, -38143,
                        -74068, -16741, 49752, 33919, 63691, 5700, -15162, -119368, -79360, -77357,
                        -9584, 55270, 31657, -118302, -68582, 118751, -25464, -61468, -61989,
                        85117, 25937, -100353, 84449, 78615, 61288, 44143, -3880, -82456, 14129,
                        -66184, 49255, -60869, 98792, -116483, -101399, -9660, 74400, -71202,
                        -33374, 31524, -30241, -5853, -64404, -90317, 79164, 25081, 22283, -101837,
                        -15192, 27986, 20520, -63357, 95890, -17152, 61747, -103086, 62744, 65567,
                        -91516, 7316, -82870,
                    ],
                },
                Polynomial {
                    coefficients: [
                        32330, -43768, 60043, 78363, -32621, 53029, 16521, -82628, -41575, -86234,
                        -47587, 43060, 13803, 18267, -11181, 678, 70886, 15864, -18348, 14214,
                        -3114, 36144, 89618, -15311, 108519, -14096, -79818, -61317, -47848, 24167,
                        81964, 65886, -7239, -49946, 39174, 90553, -61572, -13747, 18530, 66020,
                        55607, -62458, -47242, -92302, 100789, 52158, 7406, 47208, 9101, -36132,
                        -7234, 7863, 32027, 57817, -36334, -54660, -24864, -12893, -39766, -28710,
                        39488, 88058, -42391, 26374, 38591, -51305, 17641, 77632, 34648, 81929,
                        88263, 10834, 56483, -72523, -30300, -116757, 50139, -94871, -31364, 2770,
                        -61534, 96159, -79926, 52502, 95758, -75871, -10320, 1230, 17592, 3683,
                        -15597, -44718, -71204, -30054, -36537, 13208, -6521, 20445, 57385, 97904,
                        -53347, 54281, -8636, 18619, -58421, -65237, -48846, 28725, -73243, 17848,
                        77830, -58666, -95299, -74151, -34428, -17830, -41355, -45913, -33629,
                        53829, -14355, 67966, 40450, -34104, -21401, -36249, -76971, -58631, 31910,
                        -98555, 55954, 5336, -92273, 21255, -1507, -19798, -4146, -46138, 62976,
                        -21543, 20504, 95238, -60960, -53770, -10587, -61838, -37519, 52691,
                        -53495, -28099, 44538, -2617, -83255, 94018, -7343, 70471, 63934, 33214,
                        -3062, 67763, 64286, 47456, 4031, 32017, -31956, 74345, -3305, 69052,
                        49901, -44014, 59773, -84912, 7446, -8850, 29881, 47630, -105698, 89586,
                        96083, 47070, 21009, 12353, -49249, -34472, 10023, 33988, 73084, 32449,
                        -75958, 20563, -25332, 20254, -74642, -18605, 32942, 20652, -102060,
                        -23657, -97229, 78919, -56408, 96590, 91291, -92015, -102375, 5707, 34381,
                        -60343, 77924, -63969, 80416, -76357, 5717, -108675, -24094, -41051, 3333,
                        100632, 15141, -79501, -108839, -26901, 12155, -69249, -66177, 66579,
                        69631, -17353, 44282, -74848, -121948, -38053, -104448, -19831, -49089,
                        37686, 85725, 6837, 61960, -585, 93852, 82228, -26560, 24751, -2962,
                        -26389, -65183, 10974, -24523, 72910, -57659, 69613, -90218, -34440, 41611,
                        106096,
                    ],
                },
            ],
        };

        PolyVec::<4>::make_hint::<{ (Q as usize - 1) / 88 }>(&mut h, &W_ONE_TEST, &v_zero);

        assert_eq!(h[0].coefficients, H_TEST[0].coefficients);
        assert_eq!(h[1].coefficients, H_TEST[1].coefficients);
        assert_eq!(h[2].coefficients, H_TEST[2].coefficients);
        assert_eq!(h[3].coefficients, H_TEST[3].coefficients);
    }

    #[test]
    fn test_should_decompose_correctly_the_w_vector() {
        let w = PolyVec::<4> {
            data: [
                Polynomial {
                    coefficients: [
                        4365144, 6157465, 7100828, 884169, 7812379, 2130549, 5392787, 8064915,
                        5552592, 3987250, 4366416, 3630069, 7614714, 4217994, 6108844, 7800996,
                        794966, 7550282, 4050296, 7104362, 292890, 7565690, 7765654, 5679027,
                        7626940, 5384759, 3468096, 1477798, 3689999, 2455204, 1786089, 2957253,
                        7881516, 3286054, 1692813, 5840896, 5293419, 372393, 2016964, 8127336,
                        5601005, 5204804, 5959160, 3772215, 2263009, 135150, 7666939, 1187114,
                        7970092, 1654725, 3578514, 7889718, 6982072, 7730264, 4672400, 4600553,
                        1892965, 6263914, 7161614, 853633, 6843068, 6143738, 1305935, 7684652,
                        4403112, 5133833, 7193146, 1612034, 908211, 3564336, 7247725, 6591967,
                        6883500, 2805195, 6324439, 5049714, 2639250, 4690889, 1617220, 2184927,
                        1871985, 1246661, 3915980, 1484617, 5152126, 832419, 1065670, 952673,
                        2830261, 7428465, 1145878, 5216565, 893058, 4850534, 6978457, 4726566,
                        4985775, 8282382, 7319411, 3514086, 8238681, 5950915, 6217840, 1758802,
                        1369944, 3516652, 6478631, 6533238, 3387234, 4631139, 5704343, 4391088,
                        5649519, 6795345, 4640368, 6844976, 1568551, 219411, 7010072, 1244188,
                        2242994, 6348551, 2278097, 5508202, 2145087, 2639490, 5910685, 6579805,
                        7732457, 1321359, 4474657, 6565981, 3293342, 4270121, 3129008, 199228,
                        1564882, 5830933, 28135, 1470991, 1494799, 2696691, 6703136, 1859635,
                        111086, 4353917, 3534207, 5590426, 5038856, 326741, 7751299, 6068148,
                        8354857, 3308102, 2182037, 1662575, 704550, 3720670, 305520, 7276131,
                        2790235, 1593288, 2750704, 4201761, 6399589, 687453, 6526055, 2933166,
                        7345628, 2472493, 8026351, 53279, 3077144, 3453525, 245506, 2538683,
                        372398, 7107086, 4077098, 7526652, 6246911, 7531371, 4782295, 5421824,
                        942467, 1938117, 6685465, 2770093, 7785175, 7691566, 3411407, 3545068,
                        2737884, 438138, 4978686, 5055993, 5747458, 3993922, 125827, 6849312,
                        651715, 5416209, 2960295, 2914700, 7648756, 84800, 1752285, 3369804,
                        7452842, 1750543, 3530324, 119716, 5828320, 6743465, 6011276, 3458152,
                        6111925, 4798767, 317344, 26371, 7745751, 6409667, 7892302, 547019,
                        5976140, 2195888, 8286542, 3138169, 4533653, 925356, 3276303, 6524062,
                        5458695, 1017987, 5075513, 7165508, 8198957, 7670293, 229980, 6686351,
                        4140989, 1299651, 4080598, 3829634, 16772, 4940084, 3368014, 63119,
                        6143235, 7897145, 4661108, 8249659, 5652608, 565722, 2056512, 819118,
                    ],
                },
                Polynomial {
                    coefficients: [
                        329996, 7189337, 5411990, 3020422, 263577, 5758227, 1623925, 2088645,
                        7832263, 7060091, 6743452, 4634102, 5395598, 1959104, 3007252, 3950978,
                        713712, 7485523, 1518607, 7391529, 429614, 6318669, 2270552, 4461299,
                        6529712, 4370028, 2667004, 148166, 4421445, 4492288, 4503295, 3703411,
                        5513922, 5453549, 7943088, 405021, 2821838, 85335, 5710102, 1117399,
                        1373131, 5847131, 28884, 8070457, 7386509, 4701103, 7824088, 7472699,
                        4729819, 5487940, 749346, 311, 6370301, 2729943, 6175102, 6494600, 3915628,
                        4379799, 2157291, 3674849, 4715847, 7117692, 5765260, 5361353, 4527815,
                        2797868, 5848284, 7453426, 4517014, 3529812, 4602018, 7770091, 4845639,
                        1691566, 8121822, 6967803, 1327640, 3068196, 540642, 145721, 6180025,
                        1288711, 3217035, 1839712, 1013756, 5842289, 4380161, 2752156, 8009802,
                        3873089, 3596033, 6594776, 4872718, 1015183, 6807132, 1122377, 526452,
                        6864386, 6176715, 724218, 5573085, 5625485, 5767323, 6950291, 1473010,
                        667662, 1437555, 191414, 7365385, 983280, 29812, 4272351, 3719459, 1265174,
                        3239329, 5884871, 8057071, 2691797, 4656454, 5643464, 5900253, 8347887,
                        5943086, 5205625, 6648827, 886271, 2228547, 7924673, 2247601, 3371759,
                        3863789, 3731778, 5986961, 5004122, 3034509, 6639696, 828380, 671547,
                        5430663, 1853409, 5966195, 4618575, 7537602, 3765772, 3522457, 881467,
                        4026201, 4149736, 5845745, 5646158, 182729, 4063860, 7194990, 1815709,
                        3700263, 1161135, 3544253, 654954, 3323224, 6861431, 4919732, 1585406,
                        675659, 5864410, 6507154, 6314004, 2766177, 541432, 5905108, 7265100,
                        4322995, 5250265, 4546036, 683837, 7550927, 6984191, 2347732, 1767089,
                        2280503, 7542498, 7645768, 2053850, 756713, 3157203, 383709, 2374288,
                        7236614, 2747967, 5273430, 7647164, 6571539, 4183167, 7393554, 215012,
                        3003260, 268925, 126965, 6415702, 8236484, 7437444, 7510362, 1144033,
                        6919994, 4769015, 7401609, 7119808, 7677916, 6981623, 6304689, 5656959,
                        5553064, 8325891, 7262211, 3183294, 2434775, 1185805, 2844923, 206337,
                        3389788, 1722631, 2098308, 1182724, 5216290, 2461848, 4033537, 5429842,
                        2265052, 6658305, 6801414, 283368, 1378042, 5225124, 2606959, 2349750,
                        2733535, 5988636, 7369627, 730311, 5058015, 2578696, 4188127, 6472779,
                        4075520, 4227835, 7723336, 5094776, 7461406, 5266884, 872019, 2846555,
                        5125637, 1918400, 2161093, 6527355, 1549657, 5594780,
                    ],
                },
                Polynomial {
                    coefficients: [
                        7667662, 5215434, 4307502, 6778246, 3646698, 1901969, 6454462, 5142922,
                        6450224, 6886428, 1693078, 7712207, 2436488, 1293555, 353719, 7635319,
                        7517654, 4270626, 7601708, 1945909, 938004, 2181606, 253755, 7620324,
                        5287020, 899580, 6125884, 6786337, 1921238, 5687751, 2554202, 5092934,
                        2609002, 1705418, 4588670, 8050440, 4854076, 1543807, 2866729, 882959,
                        8019522, 2659508, 8008691, 3260100, 5971894, 4508464, 2523517, 531396,
                        3965695, 6929115, 2983960, 591551, 7592915, 794415, 4759294, 6132747,
                        796856, 5800245, 2777434, 2648033, 7097108, 4017212, 5702327, 2338555,
                        763123, 7639510, 1435102, 145011, 7111436, 975422, 2701214, 6370197,
                        2813023, 7448209, 7602519, 7167533, 1184030, 256787, 7702597, 87678,
                        7789023, 1287567, 1217732, 6813865, 2486658, 5933241, 1019965, 6075615,
                        6287082, 6359463, 7738123, 3844994, 4138868, 5856290, 7805830, 1381471,
                        6124827, 1196212, 3066749, 6083155, 6085189, 5100125, 4675094, 70334,
                        3064358, 6645818, 1853255, 3501146, 2138819, 2623218, 4478208, 6141530,
                        4445821, 6051140, 4530129, 7826719, 64062, 1318220, 4720784, 883142,
                        6815296, 4766718, 6965347, 7759516, 2441409, 1680080, 2934714, 4195242,
                        8124921, 6935413, 2889572, 6028333, 3689726, 1882805, 2690304, 2993337,
                        6471526, 5131899, 357280, 7193166, 2388247, 7927792, 353610, 537236,
                        2298887, 318519, 7227356, 7782107, 3780137, 3764848, 8104176, 5843248,
                        6801310, 3409379, 2814403, 93520, 5305789, 4493872, 582773, 7196032,
                        5539901, 3626446, 3024984, 5118271, 1615234, 4316548, 1699802, 2521411,
                        441978, 8279421, 1666314, 2353082, 7969867, 7313220, 4301455, 7838385,
                        7098328, 354721, 1243554, 3211869, 7561633, 4027640, 5116471, 7566049,
                        1826409, 3220930, 3356044, 4635792, 4350138, 3448262, 934337, 315710,
                        3155011, 6349046, 4924463, 299464, 3596652, 3671582, 7101983, 2181738,
                        1346107, 8366646, 1811045, 2765607, 1064424, 8187949, 5742927, 2521847,
                        2193556, 4919477, 8085139, 7778074, 528633, 3175294, 6568889, 3865703,
                        2008684, 2931794, 4837395, 5191830, 2329678, 381982, 6792028, 3822008,
                        2598897, 1977864, 2216304, 8091005, 5429024, 3720631, 3044150, 2350863,
                        4491703, 7401525, 6102374, 2839293, 3035047, 5265184, 7532253, 6184829,
                        1161144, 763575, 7524826, 3780281, 5176117, 1728523, 4338359, 2373362,
                        931909, 3108451, 1243462, 7857988, 7287394, 4668691, 8378335, 4883282,
                    ],
                },
                Polynomial {
                    coefficients: [
                        1946887, 150382, 6679568, 5387537, 8328298, 1940080, 6315189, 2021340,
                        1875486, 3735495, 5684862, 4036581, 207442, 4207222, 1695854, 3432748,
                        3124251, 5151923, 5281015, 6666522, 5141152, 4993309, 5604382, 2266426,
                        283537, 160406, 8289596, 1491858, 2226447, 4015723, 262492, 4059373,
                        1515624, 7930668, 4054401, 3709389, 6811592, 5956058, 6315437, 5614299,
                        1761824, 7181226, 3937924, 6762425, 2751873, 1403972, 6474083, 7666022,
                        4197205, 6250332, 2473470, 6668820, 7426109, 8062660, 5675248, 1841432,
                        6429215, 7033700, 5883641, 7769421, 4627866, 4663003, 911798, 778425,
                        447024, 7032627, 8010414, 8282758, 403071, 7130238, 6752886, 562179,
                        5581436, 1262967, 6466400, 7536911, 4828369, 1622309, 8342907, 3213195,
                        2621721, 6365722, 5259129, 801343, 2379409, 1083189, 1513132, 5335806,
                        6869161, 3415566, 4552439, 4551456, 3747593, 3777352, 7378198, 6109822,
                        3413234, 6688948, 824624, 5426506, 3932522, 7124712, 1524131, 583870,
                        2613350, 4899595, 4918555, 1730404, 4864886, 5722025, 2541651, 4320372,
                        8107165, 8109308, 6641796, 749474, 333587, 1867558, 2259520, 4056436,
                        8341794, 6163095, 7479072, 6815788, 5307415, 6430394, 2015436, 499528,
                        803843, 7340455, 2530925, 7799224, 868213, 7431954, 6485032, 5692748,
                        4168831, 322127, 639245, 3055385, 5536471, 7509719, 7564483, 5083173,
                        1520099, 909155, 7963456, 1400358, 6417455, 3016106, 8036407, 7238445,
                        3144718, 4269526, 7439071, 6544881, 6543147, 3236161, 1313417, 6744416,
                        1021852, 5191985, 3802765, 7437182, 6032666, 7328112, 1338534, 4471789,
                        4614897, 5114953, 3120418, 7727173, 4198672, 770005, 4204038, 2728273,
                        7143602, 1999328, 5223028, 5928763, 4426633, 3803861, 6982955, 1111559,
                        5905818, 452530, 6735556, 2690316, 6212498, 6289402, 3213299, 2299129,
                        7172183, 3425813, 2856446, 6884145, 4102960, 549860, 1240389, 1596225,
                        2984705, 4459703, 1990883, 3737653, 8113973, 8184405, 2142527, 3945291,
                        8084246, 7356147, 1425726, 6969179, 5719359, 7159459, 4365152, 355569,
                        359264, 5234692, 1537826, 1248962, 3722068, 1526595, 2497610, 711486,
                        7351564, 4631465, 8050913, 5121672, 8224540, 4872206, 5812313, 6432721,
                        2578803, 7071208, 7757450, 5774869, 6951809, 4405921, 8248629, 12430,
                        4464689, 3902595, 5299806, 2897131, 6888660, 1107777, 4507077, 396756,
                        7400954, 1226545, 5278206, 2940836, 6780037, 2245951, 4419376, 6759867,
                    ],
                },
            ],
        };

        let (w_one, w_zero) = PolyVec::<4>::decompose::<{ (Q as usize - 1) / 88 }>(&w);

        let expected_w_0 = PolyVec::<4> {
            data: [
                Polynomial {
                    coefficients: [
                        -15528, 62617, 53660, -68151, 3355, 35445, 59795, 65427, 29136, -12494,
                        -14256, 11253, -3846, 27786, 13996, -8028, 33110, -68278, 50552, 57194,
                        -88038, -52870, -43370, -34893, 8380, 51767, 39744, -45914, 71183, -20828,
                        71913, -90171, 72492, 48166, -21363, -63488, -39573, -8535, -78140, -62616,
                        77549, 62276, 54776, -37065, -22559, -55314, 48379, 44330, -29396, -59451,
                        -40302, 80694, -65096, -78760, -89200, 29417, -11675, -21398, -76018,
                        91777, -13636, 48890, -27313, 66092, 22440, -8695, -44486, 88322, -44109,
                        -54480, 10093, -74273, 26796, -51765, 39127, -92814, -27246, -70711, 93508,
                        89823, -32655, -86587, -83764, -39095, 9598, 70563, -77114, 353, -26699,
                        369, 3094, 74037, -59262, 88934, -68711, -35034, 33711, 92430, 81779,
                        85734, 48729, 46531, -67472, 44626, 36696, 88300, 2855, 57462, -41118,
                        60003, -9577, 10416, -64401, -61359, 69232, -11728, 44839, 28947, -37096,
                        -89060, -42574, 63239, -7471, -15254, 49983, -27006, 6301, -86435, -76567,
                        -11889, 93985, 90205, 55454, 79913, 81584, 8764, 41170, -73451, 28135,
                        -52721, -28913, 30195, 36896, -45005, -79378, -26755, -84609, 66970, 86792,
                        -54187, -57725, -26700, -25560, 70214, 86933, -51601, -57306, -88610,
                        -75408, 38499, -66725, 69576, 84208, 11553, -76187, -74403, 50279, 76206,
                        -82468, -3539, 26863, 53279, 29720, 25173, 55042, 62651, -8530, 59918,
                        77354, -91908, -38401, -87189, 20695, 88832, -9853, 33477, 19225, -86867,
                        -23849, 73006, -16945, -73748, 71388, 57210, 26622, -86535, 33538, -5822,
                        -64637, -7392, 80323, 83217, -87129, 57740, 30196, 84800, 38109, -58548,
                        24746, 36367, -88492, -70748, -76064, 77225, -83572, 29800, 17077, 37167,
                        -63584, 26371, -63273, -66109, 83278, -24373, 71756, -89680, -93875, 90745,
                        -37483, -26964, 38415, 48286, -64761, 65667, -67015, -72124, 9005, 51733,
                        39516, 20111, -49219, -33597, 80854, 20354, 16772, -11980, -60338, 63119,
                        48387, 88121, 89972, 59707, -61312, -5670, -38592, 57262,
                    ],
                },
                Polynomial {
                    coefficients: [
                        -50932, -48295, 78998, -27002, 73113, 44307, -90251, -6459, 23239, 12923,
                        77212, 62966, 62606, 54464, -40172, -48766, -48144, 57427, -5105, -36567,
                        48686, 33357, -15016, 80627, 53936, -10644, 508, -42298, 40773, -78848,
                        -67841, 84595, -9534, -69907, -56400, 24093, -35122, 85335, -3818, -25385,
                        39883, -57253, 28884, 70969, -41587, -60497, 15064, 44603, -31781, -35516,
                        -12510, 311, 84989, 63447, 80254, 18824, -84116, -873, 62187, 56033,
                        -45753, 70524, 51340, 28361, -43321, -59092, -56100, 25330, -54122, -89004,
                        30882, -38933, 84039, -22610, -68130, -79365, -5608, 20772, -30750, -44743,
                        85177, -44537, -20853, -64928, 61436, -62095, -511, 85660, 10314, 63809,
                        -22783, -71464, -79346, 62863, -49572, -20407, -44940, 7682, 81867, -37638,
                        49629, -88435, 53403, 93587, -50702, -94194, -86157, 950, -62711, 30960,
                        29812, 82143, -89821, -68074, 1441, -19513, 57583, 25301, 85318, -70456,
                        -4131, -32530, 38702, 63097, -17413, -66049, -57021, -74815, -37967,
                        -56593, 54509, -77502, 82577, 52058, -12915, -26544, 66524, -90309, -92793,
                        -51231, 61811, 47439, -80958, -43508, 94105, -70853, 26457, -40472, -58639,
                        -67762, -7735, 64116, -42642, -88931, 81447, 18351, -74563, 83562, 85336,
                        4727, -32332, 61694, -86197, -39974, 31378, 28692, -90783, -29960, 724,
                        27468, -57677, -82727, -25100, -78019, -67633, -62977, 62164, 52913, -5065,
                        -76062, 27208, -41254, -5143, -80685, 2781, 88720, -1018, 81471, -59562,
                        28604, -94701, -7041, -34542, 24548, -44164, 78461, -63499, -60074, 46532,
                        9348, 82266, 1249, 63290, 7415, -26487, 72640, 59356, -65545, 19377,
                        -56961, 29608, -54526, 24579, -54594, -41257, 43021, -12037, 15873, -38564,
                        8455, 3204, 39940, 73762, -14184, 33793, -93614, -20516, -7935, -55290,
                        92904, 44794, 82596, -59537, 64182, 67039, 84252, -58469, -31545, -84513,
                        -87800, -2081, -2997, 75776, 37627, -85688, -47752, 33310, -66108, -80301,
                        -10405, -16891, 13760, 65989, 51579, 25945, 71324,
                    ],
                },
                Polynomial {
                    coefficients: [
                        49102, 72906, -73170, -78458, 27882, -2671, -21314, 394, -25552, 29724,
                        -21098, 93647, -39544, -39693, -27209, 16759, 89558, 80418, -16852, 41269,
                        -14316, 86502, 63291, 1764, -45972, -52740, 31036, -70367, 16598, -26169,
                        78170, -49594, -57494, -8758, 17534, 50952, 92476, 20095, 9769, -69361,
                        20034, -6988, 9203, 22212, 67510, -62672, 47485, -39996, -34049, 72411,
                        -63464, 20159, -25645, 32559, -2306, 37899, 35000, 86325, -79526, -18463,
                        49940, 17468, -11593, 52987, 1267, 20950, -88610, -45453, 64268, 23102,
                        34718, 84885, -43937, 20113, -16041, -70099, 41246, 66323, 84037, 87678,
                        -20001, -45681, 74948, -42839, 10626, 28857, 67645, -19233, 1770, 74151,
                        -70901, 35714, -51340, -48094, -3194, 48223, 29979, 53428, 19325, -11693,
                        -9659, -42403, -86506, 70334, 16934, -20422, -51385, 72794, 43715, -43278,
                        -92928, 46682, 65149, -43708, -41007, 17695, 64062, -15028, -40816, -69178,
                        -41408, 5118, -81821, -49508, -34623, -34096, 77754, 5034, -65031, 78709,
                        32612, -66515, 70910, -21835, 23808, -54087, -4250, -10629, -23648, -44466,
                        -87785, -71696, -27318, -34156, 13319, -62409, -10276, -26917, -29143,
                        -44432, -85776, -61136, -55394, -18973, -42557, 93520, -27203, -77264,
                        11381, -41600, 16445, 7630, -22440, -24257, 91522, -64124, -14374, 45379,
                        61050, 89469, -47862, 67514, -29621, 75588, -79217, 29361, 51160, -26207,
                        -89694, -26019, -56927, 27896, -26057, -52511, -78231, -16958, -72308,
                        64656, -30534, 19910, -17983, -65218, -82877, 63734, -27601, -81464,
                        -22164, 52766, 54815, 86634, 12859, -13771, -93595, -91353, -78360, -2003,
                        29007, 45815, -92012, -32587, 85651, -30950, -42759, -62594, 93113, 56423,
                        -86420, 74834, 75795, 49302, 44110, 1054, -64676, 12728, -67599, 73224,
                        -69264, 91517, -94432, -88649, -3274, 65295, -79433, -26571, 7526, -17667,
                        -12377, -67808, -86307, 89981, 18360, 1719, -93734, -28999, 33589, 14347,
                        -42313, 87794, -20411, 61027, -89786, 48964, 49762, -92909, -2082, -68782,
                    ],
                },
                Polynomial {
                    coefficients: [
                        42247, -40082, 13328, 54545, -52119, 35440, 29877, -73764, -29154, -73785,
                        -29058, 36837, 16978, 17014, -18322, 4396, 76827, 9395, -51977, 282, -1376,
                        41245, 80926, -19142, 93073, -30058, -90821, -31854, -59121, 15979, 72028,
                        59629, -8088, -68820, 54657, 90573, -45112, 51674, 30125, 90843, 47648,
                        -56406, -61820, -94279, 85377, 70724, -1693, 47462, 6997, -34980, -2562,
                        2580, -1987, 63172, -38672, -63208, -46561, -13468, -20743, -39603, 56730,
                        91867, -40522, 16569, 66096, -14541, 10926, 92806, 22143, 83070, 86646,
                        -9213, 57980, -70281, -9376, -81649, 66769, -91867, -37510, -24693, -44775,
                        80410, -73863, 39487, 93841, -59595, -10580, 2814, 12457, -12786, -18697,
                        -19680, -61687, -31928, -49898, 14974, -15118, 22708, 62768, 93514, -67222,
                        77544, 419, 12478, -53146, -52469, -33509, 16228, -87178, 8105, 65619,
                        -60300, -82787, -80644, -24444, -12382, -47341, -37082, -26048, 56692,
                        -38623, 68247, 50976, -40916, -25577, -45382, -79668, -71864, 41987,
                        -87641, 54893, -9800, -84107, 3858, 9256, -21172, -21377, -58801, 67853,
                        7961, 13015, 81623, -54077, -59355, -3613, -43165, -36032, 67110, -58321,
                        -31318, 36919, 813, -93170, 79318, 10975, 69105, 67371, -1727, -19831,
                        78176, 69532, 49457, -6515, 9086, -62182, 90480, 5286, 91117, 43761,
                        -27575, 72994, -81851, 8464, 8149, 13830, 61777, -94030, 94688, 80500,
                        24379, 45961, -5419, -64213, -31225, 1434, 71602, 69316, 23820, -72814,
                        4090, -24589, 13561, -65449, -2539, -514, 27441, -87248, -21532, -92859,
                        72513, -62719, 79031, 86243, -71627, -75979, -5547, 47423, -54453, 84758,
                        -71949, 92478, -77989, 5439, -78173, -15520, -25359, -21664, 92164, 14114,
                        -84286, -87212, 2883, 21578, -50370, -76532, 60329, 51425, -20856, 34588,
                        -79858, -92071, -43055, -87693, 24040, -51574, 60949, 95105, 25249, 58677,
                        12430, 84017, 93315, -33186, 40171, 31956, -35007, -64059, 15828, -27142,
                        83761, -54786, 83876, -76667, -39617, 38704, 93627,
                    ],
                },
            ],
        };

        assert_eq!(w_one, W_ONE_TEST);
        assert_eq!(w_zero, expected_w_0);
    }
}
